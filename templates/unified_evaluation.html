{% extends "base.html" %}

{% block title %}{{ eval_config.title }} - Mastery English{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-chart-bar"></i> {{ eval_config.title }}</h1>
                <a href="{{ eval_config.back_url }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left"></i> Back to {{ eval_config.back_text }}
                </a>
            </div>
            <p class="text-muted">{{ eval_config.description }}</p>
        </div>
    </div>

    <!-- File Upload Section -->
    <div id="upload-section" class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-body text-center py-5">
                    <i class="fas fa-file-upload text-primary mb-3" style="font-size: 3rem;"></i>
                    <h3>Upload Evaluation Results</h3>
                    <p class="text-muted">{{ eval_config.upload_hint }}</p>
                    
                    <form id="upload-form" enctype="multipart/form-data" class="mt-4">
                        <div class="mb-3">
                            <input type="file" class="form-control" id="json-file" accept=".json" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-upload"></i> Process Results
                        </button>
                    </form>
                    
                    <!-- Alternative JSON Paste Method -->
                    <div class="mt-4">
                        <hr>
                        <p class="text-muted">Or paste JSON directly:</p>
                        <button type="button" class="btn btn-outline-secondary" onclick="showJSONPaste()">
                            <i class="fas fa-paste"></i> Paste JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JSON Paste Section -->
    <div id="json-paste-section" class="row justify-content-center mb-4" style="display: none;">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-code"></i> Paste Evaluation JSON
                    </h5>
                </div>
                <div class="card-body">
                    <textarea id="json-textarea" class="form-control" rows="10" 
                              placeholder="Paste your evaluation JSON here..."></textarea>
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" onclick="processJSONText()">
                            <i class="fas fa-play"></i> Process JSON
                        </button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="hideJSONPaste()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Processing...</span>
        </div>
        <h3>Processing your results...</h3>
        <p class="text-muted">Analyzing evaluation data</p>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="row" style="display: none;">
        <!-- Test Summary -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> Test Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="summary-stats">
                        <!-- Summary statistics will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Evaluation Results -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list"></i> Evaluation Results
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="downloadProcessedJSON()">
                                <i class="fas fa-download"></i> Download
                            </button>
                            {% if eval_config.supports_mastery_update %}
                            <button class="btn btn-sm btn-success" id="update-mastery-btn" onclick="updateMasteryLevels()" style="display: none;">
                                <i class="fas fa-arrow-up"></i> Update Mastery Levels
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="results-container">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Mastery Update Results -->
        {% if eval_config.supports_mastery_update %}
        <div class="col-12 mb-4" id="mastery-update-section" style="display: none;">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle"></i> Mastery Level Updates
                    </h5>
                </div>
                <div class="card-body" id="mastery-update-results">
                    <!-- Mastery update results will be populated here -->
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class UnifiedEvaluationManager {
    constructor() {
        this.currentData = null;
        this.testType = '{{ eval_config.test_type }}';
        this.supportsMasteryUpdate = {{ eval_config.supports_mastery_update | tojson }};
        
        this.bindEvents();
    }
    
    bindEvents() {
        document.getElementById('upload-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleFileUpload();
        });
    }
    
    async handleFileUpload() {
        const fileInput = document.getElementById('json-file');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select a JSON file');
            return;
        }
        
        if (!file.name.toLowerCase().endsWith('.json')) {
            alert('Please select a valid JSON file');
            return;
        }
        
        try {
            this.showLoading();
            const text = await this.readFileAsText(file);
            const data = JSON.parse(text);
            await this.processEvaluationData(data);
        } catch (error) {
            console.error('Error processing file:', error);
            alert('Error processing file: ' + error.message);
            this.hideLoading();
        }
    }
    
    readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = e => reject(e);
            reader.readAsText(file);
        });
    }
    
    async processJSONText() {
        const textarea = document.getElementById('json-textarea');
        const jsonText = textarea.value.trim();
        
        if (!jsonText) {
            alert('Please paste JSON data');
            return;
        }
        
        try {
            this.showLoading();
            const data = JSON.parse(jsonText);
            await this.processEvaluationData(data);
        } catch (error) {
            console.error('Error processing JSON:', error);
            alert('Error processing JSON: ' + error.message);
            this.hideLoading();
        }
    }
    
    async processEvaluationData(data) {
        try {
            const response = await fetch('/api/evaluation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'process',
                    data: data
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.currentData = result;
                this.displayResults(result);
            } else {
                throw new Error(result.message || 'Failed to process evaluation data');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error processing evaluation: ' + error.message);
        } finally {
            this.hideLoading();
        }
    }
    
    displayResults(data) {
        this.hideLoading();
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('json-paste-section').style.display = 'none';
        document.getElementById('results-section').style.display = 'block';
        
        this.displaySummary(data);
        this.displayEvaluationResults(data);
        
        if (this.supportsMasteryUpdate && data.evaluation_complete) {
            document.getElementById('update-mastery-btn').style.display = 'inline-block';
        }
    }
    
    displaySummary(data) {
        const summaryContainer = document.getElementById('summary-stats');
        const metadata = data.metadata || {};
        
        let summaryHTML = `
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-primary">${data.results.length}</h4>
                    <small class="text-muted">Total Questions</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-info">${data.format.replace('_', ' ').toUpperCase()}</h4>
                    <small class="text-muted">Test Format</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <h4 class="text-success">${data.evaluation_complete ? 'Yes' : 'No'}</h4>
                    <small class="text-muted">Evaluation Complete</small>
                </div>
            </div>
        `;
        
        if (metadata.test_date) {
            const testDate = new Date(metadata.test_date).toLocaleDateString();
            summaryHTML += `
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-warning">${testDate}</h4>
                        <small class="text-muted">Test Date</small>
                    </div>
                </div>
            `;
        } else {
            summaryHTML += `
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-secondary">-</h4>
                        <small class="text-muted">Test Date</small>
                    </div>
                </div>
            `;
        }
        
        summaryContainer.innerHTML = summaryHTML;
    }
    
    displayEvaluationResults(data) {
        const resultsContainer = document.getElementById('results-container');
        
        if (data.results.length === 0) {
            resultsContainer.innerHTML = '<div class="alert alert-info">No results to display</div>';
            return;
        }
        
        let resultsHTML = '<div class="table-responsive"><table class="table table-striped">';
        resultsHTML += `
            <thead>
                <tr>
                    <th>Word/Phrase</th>
                    <th>Type</th>
                    <th>User Response</th>
                    ${data.evaluation_complete ? '<th>Score</th><th>Status</th><th>Comments</th>' : '<th>Status</th>'}
                </tr>
            </thead>
            <tbody>
        `;
        
        data.results.forEach((result, index) => {
            const evaluation = result.evaluation || {};
            const wordTypeClass = this.getWordTypeClass(result.word_type);
            
            resultsHTML += `<tr>`;
            resultsHTML += `<td><strong>${result.target_word || 'N/A'}</strong></td>`;
            resultsHTML += `<td><span class="badge ${wordTypeClass}">${this.formatWordType(result.word_type)}</span></td>`;
            resultsHTML += `<td><em>"${result.user_response || 'No response'}"</em></td>`;
            
            if (data.evaluation_complete) {
                const score = evaluation.score || evaluation.overall_score || 0;
                const statusClass = score >= 7 ? 'text-success' : 'text-danger';
                const statusIcon = score >= 7 ? 'fa-check-circle' : 'fa-times-circle';
                
                resultsHTML += `<td><span class="${statusClass}">${score}</span></td>`;
                resultsHTML += `<td><i class="fas ${statusIcon} ${statusClass}"></i></td>`;
                resultsHTML += `<td><small>${evaluation.feedback || evaluation.evaluator_comments || 'No comments'}</small></td>`;
            } else {
                resultsHTML += `<td><span class="text-warning">Not Evaluated</span></td>`;
            }
            
            resultsHTML += `</tr>`;
        });
        
        resultsHTML += '</tbody></table></div>';
        resultsContainer.innerHTML = resultsHTML;
    }
    
    getWordTypeClass(wordType) {
        const classMap = {
            'vocabulary': 'bg-primary',
            'phrasal_verb': 'bg-success',
            'idiom': 'bg-info'
        };
        return classMap[wordType] || 'bg-secondary';
    }
    
    formatWordType(wordType) {
        if (wordType === 'phrasal_verb') return 'Phrasal Verb';
        return wordType.charAt(0).toUpperCase() + wordType.slice(1);
    }
    
    async updateMasteryLevels() {
        if (!this.currentData || !this.currentData.evaluation_complete) {
            alert('Cannot update mastery levels: evaluation not complete');
            return;
        }
        
        const threshold = prompt('Enter minimum score for mastery (default: 7):', '7');
        if (threshold === null) return;
        
        const numThreshold = parseInt(threshold) || 7;
        
        try {
            const response = await fetch('/api/evaluation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'update_mastery',
                    data: this.currentData,
                    threshold: numThreshold
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.displayMasteryUpdateResults(result);
                document.getElementById('update-mastery-btn').style.display = 'none';
                document.getElementById('mastery-update-section').style.display = 'block';
            } else {
                alert('Error updating mastery levels: ' + result.message);
            }
        } catch (error) {
            console.error('Error updating mastery levels:', error);
            alert('Error updating mastery levels: ' + error.message);
        }
    }
    
    displayMasteryUpdateResults(result) {
        const container = document.getElementById('mastery-update-results');
        const stats = result.statistics;
        
        let html = `
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-success">${stats.passed_count}</h4>
                        <small>Kept Mastered</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-danger">${stats.failed_count}</h4>
                        <small>Reset to Practice</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-info">${stats.total_questions}</h4>
                        <small>Total Processed</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-primary">${stats.pass_percentage}%</h4>
                        <small>Pass Rate</small>
                    </div>
                </div>
            </div>
        `;
        
        if (result.failed_items && result.failed_items.length > 0) {
            html += `
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle"></i> Words Reset to Practice:</h6>
                    <ul class="mb-0">
            `;
            
            result.failed_items.forEach(item => {
                html += `<li><strong>${item.word}</strong> (${this.formatWordType(item.type)}) - Score: ${item.score}</li>`;
            });
            
            html += '</ul></div>';
        }
        
        container.innerHTML = html;
    }
    
    downloadProcessedJSON() {
        if (!this.currentData) {
            alert('No data to download');
            return;
        }
        
        const filename = `processed-evaluation-${new Date().toISOString().split('T')[0]}.json`;
        const blob = new Blob([JSON.stringify(this.currentData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    showLoading() {
        document.getElementById('loading-state').style.display = 'block';
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('json-paste-section').style.display = 'none';
        document.getElementById('results-section').style.display = 'none';
    }
    
    hideLoading() {
        document.getElementById('loading-state').style.display = 'none';
    }
}

// Utility functions
function showJSONPaste() {
    document.getElementById('json-paste-section').style.display = 'block';
    document.getElementById('upload-section').style.display = 'none';
}

function hideJSONPaste() {
    document.getElementById('json-paste-section').style.display = 'none';
    document.getElementById('upload-section').style.display = 'block';
}

function processJSONText() {
    window.evaluationManager.processJSONText();
}

function updateMasteryLevels() {
    window.evaluationManager.updateMasteryLevels();
}

function downloadProcessedJSON() {
    window.evaluationManager.downloadProcessedJSON();
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    window.evaluationManager = new UnifiedEvaluationManager();
});
</script>
{% endblock %}